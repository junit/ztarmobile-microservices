<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd

       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.3.xsd" xmlns:util="http://www.springframework.org/schema/util">
    
    <util:properties id="invoicingDaoSql">
        <prop key="select.insert.invocing_details">
            <![CDATA[
                INSERT INTO invocing_details (product_id, year, month, day, mdn, rate_plan, days_on_plan, mou, mbs, sms, mms, creation_date) 
                SELECT (SELECT row_id FROM invoicing_catalog_product WHERE product = :product),
                       year(call_date) as 'Year',
                       month(call_date) as 'Month',
                       day(call_date) as 'Day',
                       mdn as mdn,
                       rate_plan as 'Rate-Plan',
                       ROUND((SUM(TIME_TO_SEC(TIMEDIFF(duration_end, duration_start))/3600)/24)) AS 'Days-On-Plan',
                       FLOOR(sum(actual_mou)) as 'Actual-MOU',
                       round(sum(actual_kbs/1024),0) as 'Actual-MBS',
                       FLOOR(sum(actual_sms)) as 'Actual-SMS',
                       FLOOR(sum(actual_mms)) as 'Actual-MMS',
                       NOW()
                  FROM reseller_subs_usage
                 -- WHERE product = :product  -- to reestrict only for an specific product
              GROUP BY mdn, rate_plan
              ORDER BY mdn, rate_plan
            ]]>
        </prop>
    </util:properties>
    
</beans>
